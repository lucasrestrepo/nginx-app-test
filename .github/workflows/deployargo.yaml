name: CI/CD Pipeline

on:
  pull_request:
    branches:
      - dev
      - prd

jobs:
  deploy:
    runs-on: test-argo

    steps:
      # Step 1: Checkout the Repository
      - name: Checkout Code
        uses: actions/checkout@v3

      # Step 2: Install Required Tools (Helm, Kustomize, and Argo CD CLI)
      - name: Install CLI Tools
        run: |
         # Install Argo CD CLI
         curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/download/v2.8.0/argocd-linux-amd64
         chmod +x /usr/local/bin/argocd

      # Step 3: Render Helm Templates for the Environment
      - name: Render Helm Templates
        run: |
          if [[ "${{ github.ref_name }}" == "dev" ]]; then
            helm template my-nginx-app ./helm --namespace dev > kustomize/base/rendered.yaml
          elif [[ "${{ github.ref_name }}" == "prd" ]]; then
            helm template my-nginx-app ./helm --namespace prd > kustomize/base/rendered.yaml
          fi

      # Step 4: Apply Kustomize Overlays
      - name: Apply Kustomize Overlays
        run: |
          if [[ "${{ github.ref_name }}" == "dev" ]]; then
            kustomize build kustomize/overlays/dev | kubectl apply -f -
          elif [[ "${{ github.ref_name }}" == "prd" ]]; then
            kustomize build kustomize/overlays/prd | kubectl apply -f -
          fi

      # Step 4: Log in to Argo CD CLI
      - name: Log in to Argo CD CLI
        run: |
          ARGOCD_SERVER=localhost:32443
          ARGOCD_PASSWORD=$(kubectl -n default get secret argocd-secret -o jsonpath="{.data.password}" | base64 -d)
          argocd login $ARGOCD_SERVER --username admin --password $ARGOCD_PASSWORD --insecure
    

      # Step 5: Trigger ArgoCD Sync (Optional if Auto-Sync is Disabled)
      - name: Trigger ArgoCD Sync
        run: |
          if [[ "${{ github.ref_name }}" == "dev" ]]; then
            argocd app sync nginx-app-dev
            argocd app wait nginx-app-dev --timeout 300
          elif [[ "${{ github.ref_name }}" == "prd" ]]; then
            argocd app sync nginx-app-prd
            argocd app wait nginx-app-prd --timeout 300
          fi
